
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <title>Hello, world!</title>
  </head>

  <style>
     @import url("https://fonts.googleapis.com/css2?family=Redressed&family=Merriweather:wght@300;400;700&display=swap");
    .redressed {
        font-family: "Redressed", serif;
    }
    .merriweather {
        font-family: "Merriweather", serif;
    }
    #chat-box {
    height: 70vh;
    overflow-y: auto;
    padding: 10px;
}

.message {
    padding: 10px;
    margin: 5px;
    border-radius: 10px;
    max-width: 60%;
}

.my-message {
    background-color: #007bff;
    color: white;
    align-self: flex-end;
    text-align: right;
    margin-left: auto;
}

.remote-message {
    background-color: #f1f1f1;
    color: black;
    align-self: flex-start;
}


  </style>
  <body style="background: linear-gradient(rgba(0,0,0, 0.5), rgba(0,0,0, 0.5));" >
        
    <section class="redressed">
        <div class="container mt-5 text-light">
            <div class="row d-flex">
                <!-- Bouton pour afficher/masquer la liste des utilisateurs (mobile only) -->
                <button class="btn btn-primary d-md-none mb-3" id="toggle-users">
                    ☰ Utilisateurs
                </button>
    
                <!-- Sidebar (liste des utilisateurs, visible à gauche, cachée sur mobile) -->
                <div class="col-lg-3 col-md-3 d-flex flex-column" id="user">
                    <div class="card bg-transparent " style="height: 90vh; border: solid white 1px; background: linear-gradient(rgba(0,0,0, 0.5), rgba(0,0,0, 0.5));">
                        <h5 class="card-header text-center">Utilisateurs</h5>
                        <div class="card-body">
                            <h5 class="card-title">Liste des connectés</h5>

                            <ul id="user-list">
                                <div class="card-text p-1" style="border: solid 1px white; border-radius: 2em;" > 
                                    <button  class="btn btn-outline-light me-2" type="button"
                                    style="border-radius: 4em; font-size: 1em;">
                                    <i id="user" class="fas fa-user"></i>
                                </button> {{request.user}}
                            </div>
                            </ul>
                            
                           
                        </div>
                    </div>
                </div>
    
                <!-- Chat Box (garde toujours une colonne à droite de la liste des utilisateurs) -->
                <div class="col-lg-9 col-md-9">
                    <div class="card bg-transparent" style="height: 90vh; border: solid white 1px; background: linear-gradient(rgba(0,0,0, 0.5), rgba(0,0,0, 0.5));">
                        <h5 class="card-header">
                            <a href="{% url 'index' %}" class="btn btn-primary"><- Home</a> Chat
                        </h5>
    
                        <!-- Conteneur des messages -->
                        <div class="card-body" id="chat-box" style="height: 75vh; overflow-y: auto; display: flex; flex-direction: column;">
                        </div>
    
                        <!-- Barre d'envoi de message -->
                        <div class="card-footer">
                            <div class="input-group">
                                <input id="message-input" class="form-control" type="text" placeholder="Écrivez un message..." aria-label="Message">
                                <button class="btn btn-outline-primary text-light" id="send-button" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>    
    </section>
    
    <script>
        document.getElementById('toggle-users').addEventListener('click', function() {
            const userList = document.getElementById('user-list');
            userList.classList.toggle('d-none');
        });
    </script>
    
    

<script>
    const roomName = "general";  // Remplace par une variable dynamique si nécessaire
    const username = "{{ request.user.username }}";  // Assure-toi que l'utilisateur est connecté

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    chatSocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const chatBox = document.getElementById('chat-box');

        let messageDiv = document.createElement('div');
        messageDiv.classList.add('message');

        if (data.username === username) {
            messageDiv.classList.add('my-message');  // Message à droite
        } else {
            messageDiv.classList.add('remote-message');  // Message à gauche
        }

        messageDiv.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value;
        console.log("message: ", message)
        chatSocket.send(JSON.stringify({
            'message': message,
            'username': username
        }));

        messageInput.value = '';
    }


    document.getElementById('message-input').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();  // Empêche le saut de ligne dans l'input
        sendMessage();
    }
});


</script>


<script>
    function fetchUsers() {
     // Remplace par la valeur dynamique si nécessaire

    fetch(`/get_active_users/${roomName}/`)  // Appelle la vue Django
        .then(response => response.json())
        .then(data => {
            const userListElement = document.getElementById("user-list");
            userListElement.innerHTML = ""; // Nettoyer la liste

            data.users.forEach(username => {
                const li = document.createElement("li");
                li.textContent = username;
                userListElement.appendChild(li);
            });
        })
        .catch(error => console.error("Erreur lors de la récupération des utilisateurs :", error));
}

// Mettre à jour toutes les secondes
setInterval(fetchUsers, 1000);

</script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  </body>
</html>


